## Introduction
Within this repository, there will be a stand alone bash script designed to install an all-in-one Islandora stack upon any type of platform e.g Virtual Machine, bare metal server etc.

This document is for the evaluation and testing of Islandora but with the secondary purpose of explaining all involved installation steps for wider Islandora adoption and educational transparency.

This version is an update of the "Provisioning Islandora on Ubuntu" Deployment Guide, based on Ubuntu 16 instead of 14, and including some optional configurations, such as replacing Mulgara with Blazegraph. Significant inspiration for some deviations from the previous architecture comes from "DigiBESS RELOADED", http://dev.digibess.it/doku.php?id=reloaded, as well as the current Islandora Vagrant. In particular, the option of placing data outside of the Fedora tree follows DigiBESS (http://dev.digibess.it/doku.php?id=reloaded:be_fedora), as well as the installation of Cantaloupe, though this is now also an option in the Islandora Vagrant.

We recommend that you read through all the way, before starting, in order to make some architecture decisions.

## Document Maintainer
This document is being submitted to the Islandora DevOps Interest Group to demonstrate a base Islandora install as performed and agreed upon by the Islandora Community. Any feedback should be directed at the Islandora DevOps Interest Group at https://github.com/islandora-interest-groups/Islandora-DevOps-Interest-Group.

## Disclaimer
This documentation is provided by the Islandora DevOps Interest Group "as is" and "with all faults." Islandora DevOps makes no representations or warranties of any kind concerning the safety, suitability, inaccuracies, typographical errors, or other harmful components resulting from the use of this documentation or the software installed and referenced in the documentation. There are inherent dangers in the use of any software, and the user is solely responsible for determining whether this software product and this documentation is compatible with their equipment and other software installed on their equipment. Users are also solely responsible for the protection of their equipment and backup of their data, and Islandora DevOps will not be liable for any damages one may suffer in connection with using or modifying this documentation or referenced software.

## Index

* [Server](#server)
* [Environment](#environment)
* [OS](#operating-system)
* [Software Dependencies](#package-installation)
  * [From Apt-Get Package Manager](#from-apt-get)
  * [From Source](#from-source)
   * [ghostscript](#ghostscript)
   * [libvpx](#libvpx)
   * [ffmpeg](#ffmpeg)
  * [From Binaries](#from-binary)
   * [ffmpeg2theora](#ffmpeg2theora)
   * [java and tomcat](#java-tomcat)
   * [Blazegraph](#blazegraph)
   * [Fits](#fits)
   * [Adore-Djatoka Install](#adore-djatoka-install)
   * [Cantaloupe Install](#cantaloupe-install)
   * [drush](#drush)
* [Configuration](#configuration)
  * [LibreOffice](#libreoffice)
  * [Apache and PHP](#apache-php)
  * [Setup MySQL Databases and Server](#setup-mysql)
* [Install Fedora Commons](#fedora)
  * [Fedora Commons Base Install](#fedora-base)
  * [XACML Settings](#xacml-setings)
  * [Replace Mulgara with Blazegraph](#mulgara-blazegraph)
  * [GSearch and Solr](#gsearch-solr)
  * [Solr Configuration](#solr-configuration)
  * [GSearch Multithreading](#gsearch-multithreading)
  * [Adore-Djatoka](#adore-djatoka)
  * [Cantaloupe](#cantaloupe)
  * [Setup Logging](#setup-logging)
  * [Drupal Filter](#drupal-filter)
* [Install Drupal](#install-drupal)
  * [CLUI Config](#clui-config)
  * [Islandora Modules](#islandora-modules)
  * [Libraries](#libraries)
  * [Drupal site install](#drupal-site-install)
  * [Drush Enables and Configuration](#drush-enables)
* [Notes](#notes)

## Server <a id="server"></a>
This document is outlining a single (all-in-one) Islandora stack installation using Ubuntu 16.04 LTS system. Some features of the installation are designed to facilitate later migration to a multi-host environment if it should become necessary.

For general purpose repository sites, we recommend at minimum 2-4 CPU cores and 8GB-10GB of RAM.

This would be scaled up according to user-load, the type of derivative files being generated by the system (ie. creating web friendly version of archival quality images or video are quite processor intensive) and many other factors.

## Environment <a id="environment"></a>
Create an islandora-install.properties file that should be removed or secured later (set passwords to something decent now, `apg -m 15`):
```
cat ~/islandora-install.properties

    #!/bin/bash
    DB_SERVER="localhost"
    DB_ROOT_PASSWORD="password"            # Set MySQL root password, used during 'apt-get' installation -> run 'mysql_secure_installation' after install to secure mySQL
    DRUPAL_DB_NAME="drupal7"               # Drupal database name
    DRUPAL_DB_USER="drupal"                # Drupal username for settings.php file
    DRUPAL_DB_PASS="password"              # Drupal password for settings.php file
    DRUPAL_ADMIN_USER="admin"              # Drupal admin username to log into Drupal Site
    DRUPAL_ADMIN_PASS="password"           # Drupal admin password to log into Drupal Site
    DRUPAL_SITE_NAME="Islandora Install"   # Drupal site name - displayed on the web site
    FEDORA_VERSION="3.8.1"                 # Fedora version to install:  3.5 or 3.6.2 or 3.7.0 or 3.7.1 or 3.8.1
    FEDORA_DB_NAME="fedora3"               # Name of fedora MySQL database -> fedora3 is recommended
    FEDORA_DB_USER="fedoraAdmin"           # Fedora db username -> for fedora.fcfg file
    FEDORA_DB_PASS="password"              # Fedora db password -> for fedora.fcfg file
    FEDORA_ADMIN_USER="fedoraAdmin"        # Username for http://localhost:8080/fedora/admin
    FEDORA_ADMIN_PASS="password"           # Password for http://localhost:8080/fedora/admin
    FEDORA_USER="tomcat7"                  # User that tomcat runs as
    FEDORA_HOME="/usr/local/fedora"        # Fedora home dir
    CATALINA_HOME="/var/lib/tomcat7"       # Tomcat location, not strictly necessary any more - handled by OS
    #TOMCAT_VERSION="7.0.55"               # We use the OS installed version, so don't need this
    # NOTE adjust memory so that it is no larger than half of total system memory. Depending on stack deployment this can be adjusted further. We don’t recommend running stack on system with less than 4GB of ram. Recommend adding -XX:+UseParallelOldGC for multi cpu systems
    # NOTE uncomment one of the following two 'JAVA_OPTS' values, depending on where you chose to install Solr
    # - Solr installed under the same Tomcat as Fedora
    #JAVA_OPTS="-Djava.awt.headless=true -Xms3072m -Xmx3072m -server -Djavax.net.ssl.trustStore=/usr/local/fedora/server/truststore -Djavax.net.ssl.trustStorePassword=tomcat -Dsolr.solr.home=/usr/local/fedora/solr -Dkakadu.home=/usr/local/adore-djatoka/bin/Linux-x86-64 -Djava.library.path=/usr/local/adore-djatoka/lib/Linux-x86-64 -DLD_LIBRARY_PATH=/usr/local/adore-djatoka/lib/Linux-x86-64"
    # - Solr installed under its own Jetty, for ease of migration to a different server if necessary, and to more recent versions of Solr in future
    #JAVA_OPTS="-Djava.awt.headless=true -Xms3072m -Xmx3072m -XX:+UseParallelOldGC -server -Djavax.net.ssl.trustStore=/usr/local/fedora/server/truststore -Djavax.net.ssl.trustStorePassword=tomcat -Dkakadu.home=/usr/local/adore-djatoka/bin/Linux-x86-64 -Djava.library.path=/usr/local/adore-djatoka/lib/Linux-x86-64 -DLD_LIBRARY_PATH=/usr/local/adore-djatoka/lib/Linux-x86-64"
    JAVA_HOME=/usr/lib/jvm/java-8-oracle/jre
    # Moved this down below java install please change to match java version
    TOMCAT_BASE="http://localhost:8080"
    ISLANDORA_BASE="$TOMCAT_BASE/fedora"
    # NOTE uncomment one the next two pairs of lines, depending on whether Solr is under the same Tomcat as Fedora or under its own Jetty
    # - Solr with Fedora
    #SOLR_BASE="$TOMCAT_BASE/solr"
    #SOLR_HOME="/usr/local/fedora"
    # - Solr stand alone
    #SOLR_BASE="http://localhost:8983/solr"
    #SOLR_HOME="/usr/local/solr"
    ISLANDORA_BRANCH="7.x"
    TUQUE_BRANCH="1.x"
    ERROR_LEVEL="2"
    # NOTE - the sourceforge link is no longer valid
    FEDORA_GSEARCH_URL="https://github.com/fcrepo3/gsearch.git"
    FEDORA_GSEARCH_NAME="fedoragsearch-2.8"
    # NOTE uncomment one of the next two, depending on which version of Solr you wish to install
    # - use the first if installing under the Fedora Tomcat
    # - configuration of 4.10.x is more complex, due to changes in newer versions of Solr...
    #SOLR_VERSION="4.2.0"
    #SOLR_VERSION="4.10.4"
    NUMBER_OF_GSEARCH_THREADS="2"          #do one gsearch thread per cpu might want to skip multithreading if you only have 1 cpu
    GSEARCH_UPDATER_NAMES="FgsUpdaters FgsUpdater1"
    DRUPAL_FILTER_URL="https://github.com/Islandora/islandora_drupal_filter/releases/download/v7.1.3/fcrepo-drupalauthfilter-3.8.1.jar"
    # NOTE as above, chose the pair following, depending on the version of Solr you are installing
    #SOLR_URL="http://archive.apache.org/dist/lucene/solr/4.2.0/solr-4.2.0.tgz"
    #SOLR_NAME="solr-4.2.0"
    #SOLR_URL="http://archive.apache.org/dist/lucene/solr/4.10.4/solr-4.10.4.tgz"
    #SOLR_NAME="solr-4.10.4"
    SOLR_DEFAULT_CORE_PATH="collection1"

    Q1="CREATE DATABASE IF NOT EXISTS $DRUPAL_DB_NAME CHARACTER SET utf8 COLLATE utf8_bin;"
    Q2="GRANT ALL ON $DRUPAL_DB_NAME.* TO $DRUPAL_DB_USER@localhost IDENTIFIED BY '$DRUPAL_DB_PASS';"
    Q3="CREATE DATABASE IF NOT EXISTS $FEDORA_DB_NAME CHARACTER SET utf8 COLLATE utf8_bin;"
    Q4="GRANT ALL ON $FEDORA_DB_NAME.* TO $FEDORA_DB_USER@localhost IDENTIFIED BY '$FEDORA_DB_PASS';"
    Q5="FLUSH PRIVILEGES;"
    SQL="${Q1}${Q2}${Q3}${Q4}${Q5}"

    APACHE_DEFAULT_SITE="000-default"
    # NOTE: We are using php 7.1, and APC is now deprecated, in favour of Zend Opcache, so the following needs to be dealt with at a later date
    APC_CONFIG_FILE="/etc/php/7.1/mods-available/apcu.ini"
    APACHE_USER="www-data"
    APACHE_SERVICE="apache2"
    OS_DEFAULT_DOCUMENTROOT="/var/www"
    CRON_SPOOL_DIR="/var/spool/cron/crontabs"
    #Resolvable hostname.
    DNS_HOSTNAME="yourhostname.local"
```

Source environment _(Please note: this must be redone if you close your shell mid-install)_:
```
chmod +x ~/islandora-install.properties

. ~/islandora-install.properties
```

### Operating System <a id="operating-system"></a>
1. Ensure latest core OS updates: `apt-get update && apt-get upgrade && apt-get --with-new-pkgs upgrade`. The latter will ensure you get the latest kernel patches. A reboot will probably be needed at this point.

2. Add repo to easily obtain oracle java installer: `apt-get -y install python-software-properties && add-apt-repository -y ppa:webupd8team/java && apt-get -y update`

3. Add optional multiverse repos in `/etc/apt/sources.list`. Uncomment each line in this file that ends in multiverse.

4. Add optional repo to get PHP7.1 material: `add-apt-repository -y ppa:ondrej/php && apt-get update -y`

## Software Dependencies <a id="package-installation"></a>

### Software Dependencies Installed by Apt-Get Package Manager <a id="from-apt-get"></a>
Accept license agreement and enter root password when asked.

Note: we use php7.1, while both 7.0 and 7.2 are available. 7.0 is too close to end of life, and 7.2 produces difficult to manage 'deprectated' errors in Drupal 7 (the 'each()' function is deprecated as of 7.2). You can go to 7.2, but setting 'error_reporting' to exclude deprecations doesn't seem to do anything.

Also note: 'imagemagick' in the default Ubuntu 16 repository does not supprt JPEG2000. Someone has made a patched repo (ppa:lyrasis/imagemagick-jp2) but it is now out of date. So if you need this functionality you may need to compile from source or force install an older version. The needed functionality is available from Openjpeg.

```
apt-get -y install oracle-java8-installer oracle-java8-set-default libjpeg-dev libpng12-dev libtiff5-dev php7.1 php7.1-cli php7.1-curl php7.1-dev php7.1-gd php7.1-ldap php7.1-mysql php7.1-mbstring php7.1-xsl php-apcu php-soap php-xml-htmlsax3 php-xml-parser php-xmlrpc php-xml-rpc2 php-xml-serializer php-imagick php7.1-mcrypt php-xml* mysql-server libmysql-java vim curl apache2 rsync wget imagemagick ant libimage-exiftool-perl unzip lame autoconf build-essential checkinstall git libass-dev libfaac-dev libgpac-dev libmp3lame-dev libopencore-amrnb-dev libopencore-amrwb-dev librtmp-dev libtheora-dev libtool libvorbis-dev pkg-config texi2html zlib1g-dev ffmpeg2theora poppler-utils python-pip libreoffice libreoffice-writer libreoffice-calc libreoffice-impress libreoffice-draw bibutils ufraw links monit tesseract-ocr tesseract-ocr-eng tesseract-ocr-fra tesseract-ocr-spa tesseract-ocr-ita tesseract-ocr-por tesseract-ocr-hin tesseract-ocr-deu tesseract-ocr-jpn tesseract-ocr-rus tomcat7 tomcat7-admin yasm jetty9 libx264-dev libfdk-aac-dev libopus-dev openjpeg-tools libopenjp2-tools drush unoconv rsnapshot maven apg ssl-cert fail2ban mailutils
```

You will be prompted three times for interactive installation, once from MySQL (provide a 'root' password), once from Postfix (choose 'no configuration') and once from Oracle Java (say yes to the license). Be sure to update your `islandora-install.properties` file with the MySQL password (DB_ROOT_PASSWORD). There will be an error from installing Tomcat7 (it won't start correctly). Ignore it at this time.

You should run `update-alternatives --config php` and make sure it is set to `php7.1`. Else Drupal will not install. This is because we are using the 7.1 Apache module and 7.2 material may well have been installed and set to the default for the OS during the `apt-get install`.

Run `mysql_secure_installation`. You will be prompted for the root password and answers to various questions. If you have created a strong root password at this time, feel free to enable the password validation plugin and set the strength requirements appropriately. You can always do this again later if you wish to use a weak password during the setup phase. Answer yes to all the other questions.

### Software Dependencies Compiled from Source <a id="from-source"></a> 

#### ghostscript  <a id="ghostscript"></a>

**Notes:** Ubuntu 14.04 installs ghostscript 9.10 which is currently failing our test sets and prevents tiffs from being generated from pdfs. Recommend installing from source to get correct version. Ubuntu 16.04 installs ghostscript 9.18, which appears to work. So the following is optional.
```
cd ~

wget http://downloads.ghostscript.com/public/old-gs-releases/ghostscript-9.05.tar.gz

tar xvzf ghostscript-9.05.tar.gz

cd ghostscript-9.05
  
./configure
 
make && make install

`gs --version` #should return result.

```

ffmpeg build location
```
mkdir ~/ffmpeg-source
cd ~/ffmpeg-source
```
#### libvpx <a id="libvpx"></a>
```
git clone https://chromium.googlesource.com/webm/libvpx.git

cd libvpx

git checkout 8366a6e4ba95e6d5af040815d2afbb4bfe628d3f

./configure --disable-examples --disable-unit-tests

make

checkinstall --pkgname=libvpx --pkgversion="1:$(date +%Y%m%d%H%M)-git" --backup=no --deldoc=yes --fstrans=no --default
```

#### ffmpeg <a id="ffmpeg"></a>
```
cd ~/ffmpeg-source

wget http://www.ffmpeg.org/releases/ffmpeg-3.3.7.tar.gz

tar xf ffmpeg-1.1.1.tar.gz && rm -rf ffmpeg-3.3.7.tar.gz  

cd ffmpeg-3.3.7
```

Had to do this to remove strange characters that cause build errors.
```
sed -i 's/×/x/' doc/filters.texi

sed -i 's/×/x/' doc/ffmpeg.texi

./configure --enable-gpl --enable-libass --enable-libfdk-aac --enable-libfdk-aac --enable-libmp3lame --enable-libopencore-amrnb --enable-libopencore-amrwb --enable-librtmp --enable-libtheora --enable-libvorbis --enable-libvpx --enable-libx264 --enable-nonfree --enable-version3 --enable-libopus

make

checkinstall --pkgname=ffmpeg --pkgversion="7:$(date +%Y%m%d%H%M)-git" --backup=no --deldoc=yes --fstrans=no --default

make install

hash -r
```

The following should tell apt to not upgrade ffmpeg (we need version 1.1.1):  

`apt-mark hold ffmpeg`

Cleanup ffmpeg source code: 

`ffmpeg -version && cd ~ && rm -rf ~/ffmpeg-source`

### Software Dependencies installed by Binaries <a id="from-binary"></a>

#### ffmpeg2theora  <a id="ffmpeg2theora"></a>

`cd ~ && wget http://v2v.cc/~j/ffmpeg2theora/ffmpeg2theora-0.29.linux64.bin && chmod a+x ffmpeg2theora-0.29.linux64.bin && install -m 755 ffmpeg2theora-0.29.linux64.bin /usr/bin/ffmpeg2theora && rm -rf ffmpeg2theora-0.29.linux64.bin`  

#### java and tomcat  <a id="java-tomcat"></a>
Now that java is installed, we can set `JAVA_HOME` and also add it to `~/islandora-install.properties`
 
`echo $( dirname $( dirname $( readlink -e /usr/bin/java ) ) )`

This should match the oracle java not openjdk.  

Update `~/islandora-install.properties` to match proper java version.  

For example: 

`JAVA_HOME=/usr/lib/jvm/java-8-oracle/jre`  

And source again if necessary:
 
`. ~/islandora-install.properties`

Note that you need to ensure that your update-alternatives point to the right java and javac.  

`update-alternatives --config java`  

`update-alternatives --config javac`

You should also, at this time, make your architecture choices in your `islandora-install.properties` file concerning where you will install Solr, what version, etc., as these affect the Tomcat settings we will implement in this next step. Source the file again if necessary.

Configure Tomcat (based on http://dev.digibess.it/doku.php?id=reloaded:be_base).

We create directories for the repository data outside of Fedora home, so that it is easier in future to expand storage, or to use a SAN. This follows the architecture of DigiBESS.
```
mkdir /usr/local/fedora

mkdir -p /srv/fedora/data

mkdir /srv/fedora/tmp

chown -R $FEDORA_USER:$FEDORA_USER /usr/local/fedora/ /srv/fedora/
```

Update Tomcat environment variables and JAVA OPTS:
```
sed -i s/^JAVA_OPTS/#JAVA_OPTS/ /etc/default/tomcat7

cat >> /etc/default/tomcat7 <<END_JT
JAVA_HOME=JAVA_HOME_T
JAVA_OPTS="JAVA_OPTS_T"
FEDORA_HOME=FEDORA_HOME_T
END_JT

sed -i "s|JAVA_HOME_T|$JAVA_HOME|g" /etc/default/tomcat7
sed -i "s|JAVA_OPTS_T|$JAVA_OPTS|g" /etc/default/tomcat7
sed -i "s|FEDORA_HOME_T|$FEDORA_HOME|g" /etc/default/tomcat7

cat >> /etc/default/tomcat7 <<END_JT2
PATH=$FEDORA_HOME/server/bin:$FEDORA_HOME/client/bin:$JAVA_HOME/bin:$PATH
END_JT2
```
 
**Note:** make sure you check `/etc/default/tomcat7` to ensure everything has been generated properly. If it didn’t you may have closed your shell you may need to source `islandora-install.properties` again. 

For example: 
```
JAVA_HOME=/usr/lib/jvm/java-8-oracle/jre
JAVA_OPTS="-Xms3993m -Xmx3993m -Djavax.net.ssl.trustStore=/usr/local/fedora/server/truststore -Djavax.net.ssl.trustStorePassword=tomcat"
FEDORA_HOME=/usr/local/fedora
```

Make sure the `tomcat7` service is enabled and active:
```
systemctl status tomcat7

systemctl start tomcat7
```

If this fails, it could well be due to the memory settings, or other factors such as the specification of directories that don't yet exist. Replace the first `JAVA_OPTS` line in `/etc/default/tomcat7` with something simple, like `JAVA_OPTS="-Djava.awt.headless=true -Xmx128m"`, to verify that Tomcat runs. Then enable the real value again and stop the service: `systemctl stop tomcat7`.

Optionally, add a Tomcat user for the admin interface. This should be disabled once testing is complete.

Edit `/etc/tomcat7/tomcat-users.xml`:
```

<tomcat-users>
  [ ... ]
  <user username="tomcat" password="somepassword" roles="admin-gui,manager-gui"/>
</tomcat-users>
```

#### Blazegraph  <a id="blazegraph"></a>

This step is optional. Instructions are mostly a copy of http://dev.digibess.it/doku.php?id=reloaded:be_blazeg, with a few modifications. We have to install under a separate Tomcat from Fedora, as Fedora cannot be running when rebuilding the Resource Index (see https://github.com/discoverygarden/trippi-sail/wiki/Repacing-Mulgara-with-Blazegraph). This also makes migrating this service to a separate machine easier.

Install and configure a second Tomcat.
```
cd /usr/share

wget http://apache.mirror.vexxhost.com/tomcat/tomcat-7/v7.0.86/bin/apache-tomcat-7.0.86.tar.gz

tar xzf apache-tomcat-7.0.86.tar.gz && rm -f apache-tomcat-7.0.86.tar.gz

ln -s /usr/share/apache-tomcat-7.0.86 /usr/share/tomcat7-blzg

useradd -m -d /var/bigdata -s /bin/false blazegraph

cat > /var/bigdata/.bash_profile <<END_BG
export BLZG_CONF=/etc/bigdata
export CATALINA_HOME=/usr/share/tomcat7-blzg
export CATALINA_PID="/usr/share/tomcat7-blzg/catalina.pid"
export JAVA_HOME=/usr/lib/jvm/java-8-oracle/jre
export BLZG_USER=blazegraph
export PATH=/usr/lib/jvm/java-8-oracle/jre/bin:/usr/share/tomcat7-blzg/bin:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin
# - adjust for your available memory
#export JAVA_OPTS="-server -Djava.awt.headless=true -Xmx8g -Xms8g -Dcom.bigdata.rdf.sail.webapp.ConfigParams.propertyFile=/etc/bigdata/RWStore.properties -Dlog4j.configuration=/etc/bigdata/log4j.properties -Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8 -XX:+UseG1GC -XX:+DisableExplicitGC"
export JAVA_OPTS="-server -Djava.awt.headless=true -Xmx128m -Xms128m -Dcom.bigdata.rdf.sail.webapp.ConfigParams.propertyFile=/etc/bigdata/RWStore.properties -Dlog4j.configuration=/etc/bigdata/log4j.properties -Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8 -XX:+UseG1GC -XX:+DisableExplicitGC"
END_BG

chown blazegraph:blazegraph /var/bigdata/.bash_profile
```
Edit `/usr/share/tomcat7-blzg/conf/server.xml` to set the service ports to something other than the Tomcat defaults, so as not to conflict with the Fedora Tomcat.
```
cd /usr/share/tomcat7-blzg/conf

cp server.xml server.xml.bak

sed -i "s|port=\"8005|port=\"8006|g" server.xml

sed -i "s|port=\"8080|port=\"8081|g" server.xml

sed -i "s|port=\"8009|port=\"8010|g" server.xml

sed -i "s|redirectPort=\"8443|redirectPort=\"8444|g" server.xml
```
Install and configure Blazegraph and its service.
```
mkdir -p /var/bigdata/logs

mkdir /etc/bigdata

cd ~

git clone https://github.com/discoverygarden/blazegraph_conf

cp blazegraph_conf/RWStore.properties /etc/bigdata/

cp blazegraph_conf/log4j.properties /etc/bigdata/

cp blazegraph_conf/blazegraph_init /etc/init.d/blazegraph

rm -rf blazegraph_conf

cd /usr/share/tomcat7-blzg/webapps/

wget https://sourceforge.net/projects/bigdata/files/bigdata/2.1.4/blazegraph.war/download -O blazegraph.war

chown -R blazegraph:blazegraph /usr/share/apache-tomcat-7.0.86 /var/bigdata/ /etc/bigdata/

chmod +x /etc/init.d/blazegraph

update-rc.d -f blazegraph remove

update-rc.d blazegraph defaults

systemctl start blazegraph
```
Check that Blazegraph is present at port 8081.

```
systemctl stop blazegraph
```


#### Fits  <a id="fits"></a>
```
cd /usr/local

wget http://projects.iq.harvard.edu/files/fits/files/fits-1.1.1.zip

unzip -o fits-1.1.1.zip && rm -rf fits-1.1.1.zip && ln -s fits-1.1.1 fits && chmod a+x /usr/local/fits/fits.sh
```

#### Adore-Djatoka Install<a id="adore-djatoka-install"></a>
``` 
cd /usr/local

wget http://sourceforge.net/projects/djatoka/files/djatoka/1.1/adore-djatoka-1.1.tar.gz/download -O adore-djatoka-1.1.tar.gz

tar xf adore-djatoka-1.1.tar.gz && rm -rf adore-djatoka-1.1.tar.gz

ln -s adore-djatoka-1.1 adore-djatoka
```

Make kakadu available on the command line:  
```
ln -s /usr/local/adore-djatoka/bin/Linux-x86-64/kdu_expand /usr/bin/kdu_expand

ln -s /usr/local/adore-djatoka/bin/Linux-x86-64/kdu_compress /usr/bin/kdu_compress

echo "/usr/local/adore-djatoka/lib/Linux-x86-64" > /etc/ld.so.conf.d/kakadu.conf

ldconfig
```

#### Cantaloupe Install<a id="cantaloupe-install"></a>

This is optional. Cantaloupe is an alternative large image display processer to Adore-Djatoka, for use with the Openseadragon viewer. Instructions are closely based on http://dev.digibess.it/doku.php?id=reloaded:is_cantsa, with the latest version of Cantaloupe.

```
cd /usr/local

wget https://github.com/medusa-project/cantaloupe/releases/download/v3.4.2/Cantaloupe-3.4.2.zip

unzip Cantaloupe-3.4.2.zip

rm -f Cantaloupe-3.4.2.zip

ln -s /usr/local/Cantaloupe-3.4.2 /usr/local/cantaloupe

mkdir -p /srv/cantaloupe/cache

mkdir /srv/cantaloupe/log

mkdir /srv/cantaloupe/home
```

#### Drush  <a id="drush"></a>

Ubuntu 16.4 has Drush version 5.10, which is installed above. If that causes issues, do the following.

Specify drush commit due to issues with newer drush versions and automated tests used by QA:
```
cd /usr/local

git clone https://github.com/drush-ops/drush.git && cd drush && git checkout b9e6c8c00da0fbf1227869cdf915b0c6cea466cc

ln -s /usr/local/drush/drush /usr/bin/drush
```

### Configuration <a id="configuration"></a>  

#### LibreOffice <a id="libreoffice"></a>

We use Systemd, which manages restarting on failure, so Monit is no longer needed.
```
useradd -m -d /home/libreoffice libreoffice

cat > /etc/systemd/system/libreoffice.service <<END_LO
[Unit]
Description=Headless Libreoffice API server

[Service]
Type=simple
User=libreoffice
UMask=0002
ExecStart=/usr/bin/soffice --headless --nologo --accept="socket,host=127.0.0.1,port=8100;urp"
ExecStop=/usr/bin/killall -9 soffice.bin
Restart=on-failure

[Install]
WantedBy=multi-user.target
END_LO

systemctl daemon-reload

systemctl enable libreoffice.service

systemctl start libreoffice.service
```

Verify functionality with:

`unoconv --connection 'socket,host=127.0.0.1,port=8100;urp;StarOffice.ComponentContext' -f pdf <some doc in a location writeable by user libreoffice>`

The following steps are required so that the `apache2` user can delete derivatives created by `libreoffice` in `/tmp`.

```
adduser www-data libreoffice

mkdir /tmp/fedora

chown www-data:libreoffice /tmp/fedora

chmod 770 /tmp/fedora

cp /usr/lib/tmpfiles.d/tmp.conf /etc/tmpfiles.d/

cat >> /etc/tmpfiles.d/tmp.conf <<END_T
# Make sure the Islandora tmp dir exists after reboot. Adjust cleaning schedule to taste.
d /tmp/fedora 0770 www-data libreoffice -
END_T
```

You will need to configure Drupal to account for this: set `Temporary directory` in `Configuration => Media => File system` to `/tmp/fedora`.

#### Apache and PHP  <a id="apache-php"></a>

Setup apache vhost:

Edit `/etc/apache2/sites-available/000-default.conf`:

```
<VirtualHost *:80>
    ServerAdmin webmaster@localhost

    DocumentRoot /var/www/drupal7
    <Directory />
            Options FollowSymLinks
            AllowOverride None
    </Directory>
    <Directory /var/www/drupal7/>
            Options Indexes FollowSymLinks MultiViews
            AllowOverride all
            Order allow,deny
            allow from all
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/error.log

    # Possible values include: debug, info, notice, warn, error, crit,
    # alert, emerg.
    LogLevel warn

    CustomLog ${APACHE_LOG_DIR}/access.log combined

    # These are needed for getting Adore-Djatoka working over https
    ProxyPass /fedora/get http://localhost:8080/fedora/get
    ProxyPassReverse /fedora/get http://localhost:8080/fedora/get
    ProxyPass /fedora/services http://localhost:8080/fedora/services
    ProxyPassReverse /fedora/services http://localhost:8080/fedora/services
    ProxyPass /fedora/describe http://localhost:8080/fedora/describe
    ProxyPassReverse /fedora/describe http://localhost:8080/fedora/describe
    ProxyPass /fedora/risearch http://localhost:8080/fedora/risearch
    ProxyPassReverse /fedora/risearch http://localhost:8080/fedora/risearch
    # These are for Adore-Djatoka, and work fine over http but not over https
    ProxyPass /adore-djatoka http://localhost:8080/adore-djatoka
    ProxyPassReverse /adore-djatoka http://localhost:8080/adore-djatoka
    # These are for Cantaloupe. Don't expose backend's tech/ver/brand. They work fine over both http and https
    # - This port is correct if Cantaloupe is installed under the same Tomcat as Fedora. Change if using standalone Cantaloupe.
    RequestHeader set X-Forwarded-Path /
    ProxyPass /iiif/2 http://localhost:8080/cantaloupe/iiif/2
    ProxyPassReverse /iiif/2 http://localhost:8080/cantaloupe/iiif/2
    
</VirtualHost>
```

Alternatively, for SSL encryption:

It will be helpfull to have a proper DNS entry for your host name. Certificate authorities won't talk to you without one, for example. If you are doing this on a cloud VM behind a NAT this may be an issue. You should edit your `/etc/hosts` and `/etc/hostname` files appropriately.

Edit `/etc/apache2/sites-available/000-default.conf`:

```
<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/drupal7

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    Redirect permanent / https://<your-site-FQDN>/

</VirtualHost>
```

And edit `/etc/apache2/sites-available/default-ssl.conf`:

```
<IfModule mod_ssl.c>
     <VirtualHost *:443>
         ServerAdmin webmaster@localhost

         DocumentRoot /var/www/drupal7

         LogLevel info

         ErrorLog ${APACHE_LOG_DIR}/error.log
         CustomLog ${APACHE_LOG_DIR}/access.log combined

         #   SSL Engine Switch:
         #   Enable/Disable SSL for this virtual host.
         SSLEngine on

         #   A self-signed (snakeoil) certificate can be created by installing
         #   the ssl-cert package. See /usr/share/doc/apache2/README.Debian.gz for more info.
         #   If both key and certificate are stored in the same file, only the
         #   SSLCertificateFile directive is needed.
         SSLCertificateFile      /etc/ssl/certs/ssl-cert-snakeoil.pem
         SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key

         <Directory />
            Options FollowSymLinks
            AllowOverride None
         </Directory>
         <Directory /var/www/drupal7/>
            Options Indexes FollowSymLinks MultiViews
            AllowOverride all
            Order allow,deny
            allow from all
         </Directory>

         # Setup for proxy to image servers
         AllowEncodedSlashes On
         ProxyRequests Off
         ProxyPreserveHost On
         <Proxy *>
             Order deny,allow
             Allow from all
         </Proxy>

         # These are needed for getting Adore-Djatoka working over https
         # - this port is correct if Adore-Djatoka is installed under the same Tomcat as Fedora. Change if installed with Blazegraph.
         ProxyPass /fedora/get http://localhost:8080/fedora/get
         ProxyPassReverse /fedora/get http://localhost:8080/fedora/get
         ProxyPass /fedora/services http://localhost:8080/fedora/services
         ProxyPassReverse /fedora/services http://localhost:8080/fedora/services
         ProxyPass /fedora/describe http://localhost:8080/fedora/describe
         ProxyPassReverse /fedora/describe http://localhost:8080/fedora/describe
         ProxyPass /fedora/risearch http://localhost:8080/fedora/risearch
         ProxyPassReverse /fedora/risearch http://localhost:8080/fedora/risearch
         # These are for Adore-Djatoka, and work fine over http but not over https
         ProxyPass /adore-djatoka http://localhost:8080/adore-djatoka
         ProxyPassReverse /adore-djatoka http://localhost:8080/adore-djatoka

         # These are for Cantaloupe. Don't expose backend's tech/ver/brand. They work fine over both http and https
         # - This port is correct if Cantaloupe is installed under the same Tomcat as Fedora. Change if using standalone Cantaloupe.
         RequestHeader set X-Forwarded-Path /
         ProxyPass /iiif/2 http://127.0.0.1:8080/iiif/2 nocanon
         ProxyPassReverse /iiif/2 http://127.0.0.1:8080/iiif/22

         # Some SSL tweaks
         ServerName <your-server-FQDN>
         SSLProtocol all -SSLv2 -SSLv3
         SSLCipherSuite HIGH:MEDIUM:!aNULL:!MD5:!SEED:!IDEA:!RC4
         SSLHonorCipherOrder on
     </VirtualHost>
</IfModule>
```
Note: You will need to modify the port specifications in the `ProxyPass` clauses above depending on where you install Adore-Djatoka and Cantaloupe. See below.

Note: the PHP module `uploadprogress` no longer appears to work. The `pecl` installation documented in "Provisioning Islandora on Ubuntu" failed to compile, and the installation below, from DigiBESS, still throws errors in the logs. Enable the apache ssl module if you are using https. Update the memory, post and upload file size limits only if you are sure you have the available memory, or when preparing to go live with a production site.
```
a2enmod rewrite  

a2enmod proxy

a2enmod proxy_http  

a2enmod headers

# - do these if you are enabling https
#a2enmod ssl

#a2ensite default-ssl

apt-get install php-uploadprogress

sed -i '929iextension=uploadprogress.so' /etc/php/7.1/apache2/php.ini 

#sed -i "s|memory_limit = 128M|memory_limit = 512M|g" /etc/php/7.1/apache2/php.ini

#sed -i "s|post_max_size = 8M|post_max_size = 2048M|g" /etc/php/7.1/apache2/php.ini

#sed -i "s|upload_max_filesize = 2M|upload_max_filesize = 2048M|g" /etc/php/7.1/apache2/php.ini

echo "apc.shm_size = 64M" >> $APC_CONFIG_FILE
```

#### Setup MySQL Databases and Server <a id="setup-mysql"></a>

Run `mysql_secure_installation` (interactive script) to ensure security, if you haven't already done so, and then set up the Drupal and Fedora databases:
 ``` 
mysql_secure_installation

MYSQL=`which mysql`  

$MYSQL -uroot -p$DB_ROOT_PASSWORD -e "$SQL"  
```
Add a general backup system using `rsnapshot`, which will also backup MySQL data.
```
cat > /root/.my.cnf <<END_MS
[client]
user="root"
password=$DB_ROOT_PASSWORD
END_MS

chmod 700 /root/.my.cnf

mkdir /root/bin /srv/dbbackups /backups

cat > /root/bin/mysqlbackup-rsnapshot.sh <<END_DBK
#!/bin/bash
#
# Dumps all relevant MySQL databases - for use with 'rsnapshot'

cd /srv/dbbackups

for dbname in $(/usr/bin/mysql --defaults-extra-file=/root/.my.cnf -Bse "show databases"|grep -iv "information_schema"|grep -iv "performance_schema"); do
  DumpName="$dbname.bz2"
  /usr/bin/mysqldump --defaults-extra-file=/root/.my.cnf --opt "$dbname" --events | bzip2 -9 >"$DumpName"
  if [ $? -gt 0 ]; then
        echo "Backup of $dbname failed! (mysqldump)"
  fi
done
END_DBK

chmod 750 /root/bin/mysqlbackup-rsnapshot.sh

sed -i 's|snapshot_root.*|snapshot_root	/backups/|' /etc/rsnapshot.conf
```
Do the following if you want 3 months worth of monthly backups kept.

`sed -i 's|#retain	delta	3|retain	delta	3|' /etc/rsnapshot.conf`

Example `LOCALHOST` backup definition section (in `/etc/rsnapshot.sh`, edit as desired):
```
backup	/home/		localhost/
backup	/etc/		localhost/
backup	/usr/local/fedora/	localhost/
backup	/var/www/drupal*/	localhost/
backup	/var/bigdata/	localhost/
backup	/srv/fedora/data/	localhost/
backup_script	/root/bin/mysqlbackup-rsnapshot.sh	localhost/mysql/
```
Note: `/etc/rsnapshot.conf` is picky about using TABs instead of spaces, so you will likely have to manually clean up the results of the above instructions.

Root's crontab should be something like this:
```
# 'rsnapshot' backup schedule: every four hours, daily, weekly, monthly
0 */4 * * *         /usr/bin/rsnapshot alpha
50 23 * * *         /usr/bin/rsnapshot beta
40 23 * * 6         /usr/bin/rsnapshot gamma
30 23 1 * *         /usr/bin/rsnapshot delta
```

Daily mysql dumps will be stored in `/srv/dbbackups` and then backed up according to the `rsnapshot` schedule in `/backups`, which could e.g. be on a separate file system or network share.

### Install Fedora Commons <a id="fedora"></a>

#### Fedora Commons Base Install  <a id="fedora-base"></a>

Create install properties file and install Fedora:
```
cd ~ 

cat > ~/install.properties <<END_IP
keystore.file=included
ri.enabled=true
messaging.enabled=true
apia.auth.required=false
database.jdbcDriverClass=com.mysql.jdbc.Driver
tomcat.ssl.port=8443
ssl.available=true
database.jdbcURL=jdbc\:mysql\://localhost/DBNAME?useUnicode\=true&amp;characterEncoding\=UTF-8&amp;autoReconnect\=true
messaging.uri=vm\:(broker\:(tcp\://localhost\:61616))
database.password=PASSWORD
database.mysql.driver=included
database.username=DBUSER
fesl.authz.enabled=false
tomcat.shutdown.port=8055
deploy.local.services=true
xacml.enabled=true
database.mysql.jdbcDriverClass=com.mysql.jdbc.Driver
tomcat.http.port=8080
fedora.serverHost=localhost
database=mysql
database.driver=included
fedora.serverContext=fedora
llstore.type=akubra-fs
tomcat.home=THOME
fesl.authn.enabled=true
database.mysql.jdbcURL=jdbc\:mysql\://localhost/DBNAME?useUnicode\=true&amp;characterEncoding\=UTF-8&amp;autoReconnect\=true
fedora.home=FHOME
install.type=custom
servlet.engine=ENGINE
apim.ssl.required=false
fedora.admin.pass=ADPASS
apia.ssl.required=false
END_IP

sed -i "s|localhost/DBNAME?|localhost/$FEDORA_DB_NAME?|g" ~/install.properties

sed -i "s|database.password=PASSWORD|database.password=$FEDORA_DB_PASS|g" ~/install.properties 

sed -i "s|database.username=DBUSER|database.username=$FEDORA_DB_USER|g" ~/install.properties  

sed -i "s|fedora.home=FHOME|fedora.home=$FEDORA_HOME|g" ~/install.properties 

sed -i "s|tomcat.home=THOME|tomcat.home=$CATALINA_HOME|g" ~/install.properties

sed -i "s|fedora.admin.pass=ADPASS|fedora.admin.pass=$FEDORA_ADMIN_PASS|g" ~/install.properties

sed -i "s|servlet.engine=ENGINE|servlet.engine=existingTomcat|g"  ~/install.properties

wget http://downloads.sourceforge.net/fedora-commons/fcrepo-installer-$FEDORA_VERSION.jar  

java -jar fcrepo-installer-$FEDORA_VERSION.jar install.properties  

rm -rf fcrepo-installer-$FEDORA_VERSION.jar install.properties  

sed -i "s|changeme|islandora|g" $FEDORA_HOME/server/config/fedora.fcfg
```

Copy over server.xml with the one provided with Fedora.

```
cp $CATALINA_HOME/conf/server.xml $CATALINA_HOME/conf/server.bak
cp $FEDORA_HOME/install/server.xml $CATALINA_HOME/conf/server.xml
```
Note: remove `maxSpareThreads` property in `$CATALINA_HOME/conf/server.xml` as it no longer does anything. Also, DigiBESS says to enable the `AJP/1.3 Connector port`.

Tweak some Fedora settings:
```
sed -i "s|security.fesl.authN.jaas.apia.enabled=false|security.fesl.authN.jaas.apia.enabled=true|g" $FEDORA_HOME/server/config/spring/web/web.properties 

# - this unzip is not necessary, as Tomcat does this on the fly now
#unzip -o $CATALINA_HOME/webapps/fedora.war -d $CATALINA_HOME/webapps/fedora

chown -R $FEDORA_USER:$FEDORA_USER $FEDORA_HOME

chown -R $FEDORA_USER:$FEDORA_USER $CATALINA_HOME
```
If you are following the usual practice of installing everything under Fedora home, do this, which is needed to be compatible with `basic-solr-configs`.

`ln -s $CATALINA_HOME $FEDORA_HOME/tomcat`

If you are keeping data separated from Fedora home, e.g. in `/srv/fedora/`, then do the following.

`cp $FEDORA_HOME/server/config/spring/akubra-llstore.xml $FEDORA_HOME/server/config/spring/akubra-llstore.xml.bak`

Edit that file and find the `<bean name="fsObjectStore"` and `<bean name="fsDatastreamStore"` clauses and replace the `<constructor-arg value="PATH"` values with appropriate ones for your installation, e.g. `/srv/fedora/data/objectStore` and `/srv/fedora/data/datastreamStore`.

Alternatively, soft links also work (Thanks '@lutaylor'!), though if you edit as above, before Fedora does its initial run, Fedora will create the directories correctly. If you are migrating an existing Fedora, use softlinks, as below for `activemq-data`.

Also:

`cp $FEDORA_HOME/server/fedora-internal-use/config/akubra-llstore.xml $FEDORA_HOME/server/fedora-internal-use/config/akubra-llstore.xml.bak`

Edit that file and find the same `bean` clauses and replace the temporary data store paths to, e.g., `/srv/fedora/tmp/objectStore` and `/srv/fedora/tmp/datastreamStore`.

Start and stop tomcat so Fedora creates some directories:

`systemctl restart tomcat7`

Note: at this point Fedora may not start for you unless your host has a 'real' hostname. So, for example, if you are building this on a virtual machine that is behind a NAT, then you may need to edit `/etc/hosts` and set `hostname` to your FQDN. This is because `mulgara`, the default triple store, will not start without being able to resolve a valid host name. The symptom to check for is errors in `/usr/local/fedora/server/logs/fedora.log` that say "This MulgaraConnector is read-only!". If you have this issue, once you have set your host name correctly, the following should correct the problem (rebuild the Resource Index):

```
systemctl stop tomcat7

/usr/local/fedora/server/bin/fedora-rebuild.sh
```

If you are keeping Fedora data outside Fedora home, while Tomcat is stopped (stop it if you haven't done so), do the following:
```
mv $FEDORA_HOME/data/activemq-data /srv/fedora/data/activemq-data

ln -s /srv/fedora/data/activemq-data $FEDORA_HOME/data/

systemctl start tomcat7
```

#### XACML Settings <a id="xacml-settings"></a>

Adjust xacml policies: 
```
rm -rf $FEDORA_HOME/data/fedora-xacml-policies/repository-policies/default/deny-purge-* 

rm -rf $FEDORA_HOME/data/fedora-xacml-policies/repository-policies/default/deny-inactive-or-deleted-objects-or-datastreams-if-not-administrator.xml  

rm -rf $FEDORA_HOME/data/fedora-xacml-policies/repository-policies/default/deny-policy-management-if-not-administrator.xml
```

**Note:** This file should either be removed or tweaked if you wish to access fedoraAdmin. Keep in mind firewall rules would need to be updated as well.
```
rm -rf $FEDORA_HOME/data/fedora-xacml-policies/repository-policies/default/deny-apim-if-not-localhost.xml  

cd ~  

git clone https://github.com/Islandora/islandora-xacml-policies && cd islandora-xacml-policies 

mkdir $FEDORA_HOME/data/fedora-xacml-policies/repository-policies/islandora_policies && cp *.xml $FEDORA_HOME/data/fedora-xacml-policies/repository-policies/islandora_policies && cd ~ && rm -rf ~/islandora-xacml-policies

chown -R $FEDORA_USER:$FEDORA_USER $FEDORA_HOME

systemctl restart tomcat7
```

#### Replace Mulgara with Blazegraph <a id="mulgara-blazegraph"></a>

This is optional. The instructions follow http://dev.digibess.it/doku.php?id=reloaded:be_repmulg. See also https://github.com/discoverygarden/trippi-sail/wiki/Repacing-Mulgara-with-Blazegraph.

Install Trippi-sail:
```
cd ~

git clone https://github.com/discoverygarden/trippi-sail.git

cd trippi-sail

mvn package -Dfedora.version=3.8.1

cd trippi-sail-blazegraph-remote/target

tar xf trippi-sail-blazegraph-remote-0.0.1-SNAPSHOT-bin.tar.gz

mv trippi-sail-blazegraph-remote-0.0.1-SNAPSHOT /usr/local/trippi-sail

cp ~/trippi-sail/trippi-sail-blazegraph-remote/src/main/resources/sample-bean-config-xml/remote-blazegraph.xml $FEDORA_HOME/server/config/spring/

cd ~ && rm -rf trippi-sail

chown -R $FEDORA_USER:$FEDORA_USER /usr/local/trippi-sail

chown -R $FEDORA_USER:$FEDORA_USER $FEDORA_HOME
```
Configure Fedora:

`cp /etc/tomcat7/Catalina/localhost/fedora.xml /etc/tomcat7/Catalina/localhost/fedora.xml.bak`

In that file, insert the following before the `<Parameter name="fedora.home"` line within the `<Context>` clause:

```
 <Loader
       className="org.apache.catalina.loader.VirtualWebappLoader"
       virtualClasspath="/usr/local/trippi-sail/*.jar"
       searchVirtualFirst="true"/>
```
Edit `$FEDORA_HOME/server/config/spring/remote-blazegraph.xml` (two edits, in quasi 'diff' format):

In the `<bean id="remoteRepoFactory"` clause insert two lines (careful about the port):
```
+               <constructor-arg type="java.lang.String" value="http://localhost:8081/blazegraph"/>
+               <constructor-arg type="boolean" value="false"/>
               <constructor-arg ref="httpClient" />
               <constructor-arg ref="executorPool" />
```
Also modify the `SesameSession` bean (change two lines):
```
-        <bean class="org.trippi.impl.sesame.SesameSession">
+        <bean class="org.trippi.impl.sesame.SesameSession" scope="prototype" >
                <constructor-arg ref="trippiSailRepository" />
                <constructor-arg ref="org.trippi.AliasManager" />
-                <constructor-arg value="test://model#" />
+                <constructor-arg value="fedora://model#"/>
                <constructor-arg value="ri" />
        </bean>
```

Edit `$FEDORA_HOME/server/config/fedora.fcfg`:

`cp $FEDORA_HOME/server/config/fedora.fcfg $FEDORA_HOME/server/config/fedora.fcfg.bak`

Comment out the `<param name="datastore" value="localMulgaraTriplestore">` clause.

Edit `$FEDORA_HOME/server/bin/env-server.sh`:

`cp $FEDORA_HOME/server/bin/env-server.sh $FEDORA_HOME/server/bin/env-server.sh.bak`

In the `execWithTheseArgs()` function:
```
-	-cp \"$webinf\"/classes:\"$FEDORA_HOME\"/server/bin:\"$webinf\"/lib/* \
+	-cp \"$webinf\"/classes:/usr/local/trippi-sail/*:\"$FEDORA_HOME\"/server/bin:\"$webinf\"/lib/* \
```

`systemctl stop blazegraph`

Edit `/etc/bigdata/log4j.properties`:

Set the default log level to `ERROR` instead of `WARN` (3 lines near the top).

`systemctl start blazegraph`

`systemctl restart tomcat7`

#### GSearch and Solr <a id="gsearch-solr"></a>

Note: part of the reason we still use older (now very old) versions of Solr is that, as of Solr 5.0 (latest is 7.3), installing Solr as a WAR servlet under containers like Tomcat is no longer supported. Also, quite significant changes in the configuration files have also happened, which makes use of the `basic-solr-config` package from Discovery Garden more difficult. DigiBESS has moved only from Solr 4.2.0 to 4.10.4 and already there are significant changes in `solrconfig.xml` and `schema.xml`. Since some will wish to stick with the tried and true, we include using 4.10.4 as optional. Hopefully this can be part of future migrations to more recent versions of Solr. Set the version of Solr you wish to use in your `install.properties`.

Grab fedoragsearch and solr - do basic config:  
```
cd ~  

git clone https://github.com/fcrepo3/gsearch.git

cd gsearch/FedoraGenericSearch

ant buildfromsource

cd ~

cp -v gsearch/FgsBuild/fromsource/fedoragsearch.war $CATALINA_HOME/webapps

chown $FEDORA_USER:$FEDORA_USER $CATALINA_HOME/webapps/fedoragsearch.war

rm -rf ~/gsearch

wget $SOLR_URL

tar -xf $SOLR_NAME.tgz
```
If you wish to install Solr under the same Tomcat as Fedora, do the following:
```
cp -r $SOLR_NAME/example/solr $FEDORA_HOME/solr

cp $SOLR_NAME/example/webapps/solr.war $CATALINA_HOME/webapps/ && unzip -o $SOLR_NAME/example/webapps/solr.war -d $CATALINA_HOME/webapps/solr 

mkdir $FEDORA_HOME/solr/$SOLR_DEFAULT_CORE_PATH/data

chown -R $FEDORA_USER:$FEDORA_USER $FEDORA_HOME
```
If you wish to install Solr under its own container, do the following (from http://dev.digibess.it/doku.php?id=reloaded:be_solr). We use Jetty, rather than Tomcat, because that's what the Solr developers have chosen to use ("Only Jetty recieves testing... No tests are done with other containers before release..." (http://lucene.472066.n3.nabble.com/difference-between-apache-tomcat-vs-Jetty-td4096680.html)).
```
cp -R $SOLR_NAME/example /usr/local/solr

cp -R $SOLR_NAME/contrib /usr/local/solr/

cp -R $SOLR_NAME/dist /usr/local/solr/

systemctl stop jetty9

ln -s /usr/share/jetty9/start.ini /usr/local/solr/start.ini

cp /etc/default/jetty9 /etc/default/solr
```
Edit `/etc/default/solr`:
```
cat >>/etc/default/solr<<END_JT
JAVA_HOME=/usr/lib/jvm/java-8-oracle
# - adjust for your memory
JAVA_OPTIONS="-Xmx256m -Xms256m -Djava.awt.headless=true -Dsolr.solr.home=/usr/local/solr/solr -Djava.net.preferIPv4Stack=true"
JETTY_USER=jetty
JETTY_HOME=/usr/local/solr
JETTY_ARGS="jetty.port=8983"
JETTY_LOGS=/usr/local/solr/logs
END_JT
```
Turn off `jetty9` and configure the `solr` service:
```
sed -i "s|NO_START=0|NO_START=1|" /etc/default/jetty9

update-rc.d -f jetty9 remove

update-rc.d jetty9 defaults

systemctl disable jetty9

cp /usr/share/jetty9/bin/jetty.sh /etc/init.d/solr

chmod +x /etc/init.d/solr
```
Insert the following in `/etc/init.d/solr` at line 17 (just after the `chkconfig` block):
```
# chkconfig: 2345 64 36
# description: Jetty9 with Solr
### BEGIN INIT INFO
# Provides: solr
# Required-Start: $all
# Required-Stop: $all
# Default-Start: 2 3 4 5
# Default-Stop: 0 1 6
# Short-Description: Start solr/jetty9 at boot.
# Description: Start the jetty9 servelet container holding Solr.
### END INIT INFO
```
Note: We are putting Solr data under `/srv/`, as with Fedora data, as part of the move away from "everything under Fedora".
```
mkdir -p /srv/solr/data

chown -R jetty:jetty /srv/solr

cat > /etc/systemd/system/solr.service<<END_SS
[Unit]
Description=Solr Index running under jetty9
SourcePath=/etc/init.d/solr

[Service]
Type=simple
ExecStart=/etc/init.d/solr start
ExecStop=/etc/init.d/solr stop
#Restart=/etc/init.d/solr restart

[Install]
WantedBy=multi-user.target
END_SS

systemctl enable solr.service
```
Prepare `fedoragsearch`:
```
cd $CATALINA_HOME/webapps/fedoragsearch/FgsConfig

ant generateIndexingXslt

### NOTE: Choose one of these, first for Solr under Fedora Tomcat, second for stand alone Solr
#ant -f fgsconfig-basic.xml -Dlocal.FEDORA_HOME=$FEDORA_HOME -DgsearchUser=$FEDORA_ADMIN_USER -DgsearchPass=$FEDORA_ADMIN_PASS -DfinalConfigPath=$CATALINA_HOME/webapps/fedoragsearch/WEB-INF/classes -DlogFilePath=$FEDORA_HOME/server/logs -DfedoraUser=$FEDORA_ADMIN_USER -DfedoraPass=$FEDORA_ADMIN_PASS -DobjectStoreBase=$FEDORA_HOME/data/objectStore -DindexDir=$FEDORA_HOME/solr/$SOLR_DEFAULT_CORE_PATH/data/index -DindexingDocXslt=foxmlToSolr -propertyfile fgsconfig-basic-for-islandora.properties

#ant -f fgsconfig-basic.xml -Dlocal.FEDORA_HOME=$FEDORA_HOME -DgsearchUser=$FEDORA_ADMIN_USER -DgsearchPass=$FEDORA_ADMIN_PASS -DfinalConfigPath=$CATALINA_HOME/webapps/fedoragsearch/WEB-INF/classes -DindexEngine=Solr -DindexBase=http://127.0.0.1:8983/solr/collection1 -DlogFilePath=$FEDORA_HOME/server/logs -DfedoraUser=$FEDORA_ADMIN_USER -DfedoraPass=$FEDORA_ADMIN_PASS -DfedoraVersion=$FEDORA_VERSION -DobjectStoreBase=/srv/data/objectStore -DindexDir=/srv/solr/data/index -DindexingDocXslt=foxmlToSolr -propertyfile fgsconfig-basic-for-islandora.properties

### backup some default files which will be clobbered in the next section.
cd $SOLR_HOME/solr/$SOLR_DEFAULT_CORE_PATH/conf

mv schema.xml schema.xml.bak  

mv solrconfig.xml solrconfig.xml.bak  

cd $CATALINA_HOME/webapps/fedoragsearch/WEB-INF/classes/fgsconfigFinal/index/FgsIndex/

mv foxmlToSolr.xslt foxmlToSolr.xslt.bak 
```

##### Solr Configuration <a id="solr-configuration"></a>
```
cd ~

git clone --recursive git://github.com/discoverygarden/basic-solr-config.git 

cd basic-solr-config 

### NOTE: Choose one of the following two, the first if you are using Solr 4.2.0, the second if you are using Solr 4.10.4.
#git checkout 4.x

#git checkout 4.10.x

mv ~/basic-solr-config/conf/* $SOLR_HOME/solr/$SOLR_DEFAULT_CORE_PATH/conf  

mv ~/basic-solr-config/islandora_transforms $CATALINA_HOME/webapps/fedoragsearch/WEB-INF/classes/fgsconfigFinal/index/FgsIndex

mv ~/basic-solr-config/foxmlToSolr.xslt $CATALINA_HOME/webapps/fedoragsearch/WEB-INF/classes/fgsconfigFinal/index/FgsIndex/foxmlToSolr.xslt  

cp ~/basic-solr-config/index.properties $CATALINA_HOME/webapps/fedoragsearch/WEB-INF/classes/fgsconfigFinal/index/FgsIndex/index.properties

cd ~ 

rm -rf ~/basic-solr-config

rm -rf ~/$SOLR_NAME* 
```
If you are running Solr not under the Fedora tree, we will have to edit some values in the following file:
```
sed -i "s|<lib dir=\"../../..|<lib dir=\"$SOLR_HOME|" $SOLR_HOME/solr/$SOLR_DEFAULT_CORE_PATH/conf/solrconfig.xml

sed -i "s|{solr.data.dir:}|{solr.data.dir:/srv/solr/data}|" $SOLR_HOME/solr/$SOLR_DEFAULT_CORE_PATH/conf/solrconfig.xml

chown -R jetty:jetty $SOLR_HOME
```
Similarly, because of the location of the OS based Tomcat and the separation of Solr, we need to edit a few files in the `fedoragsearch` configuration:
```
cd $CATALINA_HOME/webapps/fedoragsearch/WEB-INF/classes/fgsconfigFinal/index/FgsIndex/

sed -i "s|/usr/local/fedora/tomcat|$CATALINA_HOME|" foxmlToSolr.xslt

sed -i "s|/usr/local/fedora/tomcat|$CATALINA_HOME|" islandora_transforms/slurp_all_MODS_to_solr.xslt

sed -i "s|/usr/local/fedora/tomcat|$CATALINA_HOME|" islandora_transforms/WORKFLOW_to_solr.xslt

# Do the two following if your Solr is not under the Fedora tree
#sed -i "s|:8080/|:8983/|" index.properties

#sed -i "s|/usr/local/fedora/solr/collection1/data/index|NOT_USED|" index.properties
```

Discovery Garden gsearch extensions. Do one of the following:
```
cd $CATALINA_HOME/webapps/fedoragsearch/WEB-INF/lib  

wget https://github.com/discoverygarden/dgi_gsearch_extensions/releases/download/v0.1.1/gsearch_extensions-0.1.1-jar-with-dependencies.jar -O gsearch_extensions-0.1.1-jar-with-dependencies.jar
```
Or (gets you the latest release version, currently 0.1.3):
```
cd ~

git clone https://github.com/discoverygarden/dgi_gsearch_extensions.git

cd dgi_gsearch_extensions/

mvn package

cp target/gsearch_extensions-0.1.3-jar-with-dependencies.jar $CATALINA_HOME/webapps/fedoragsearch/WEB-INF/lib/

cd ~

rm -rf dgi_gsearch_extensions
```

#### Adore-Djatoka <a id="adore-djatoka"></a>

Install djatoka war:  

`cp /usr/local/adore-djatoka/dist/adore-djatoka.war $CATALINA_HOME/webapps && chown -R $FEDORA_USER:$FEDORA_USER $CATALINA_HOME/webapps/adore-djatoka*`

Optionally, install this under the Blazegraph Tomcat (for separability):

`cp /usr/local/adore-djatoka/dist/adore-djatoka.war /usr/share/tomcat7-blzg/webapps && chown -R blazegraph:blazegraph /usr/share/tomcat7-blzg/webapps/adore-djatoka*`

Note: If you install Adore-Djatoka with Blazegraph, you will need to change the `ProxyPass` lines in your Apache configuration to port `8081` instead of `8080` and also modify the JAVA_OPTS in `/var/bigdata/.bash_profile`.

#### Cantaloupe <a id="cantaloupe"></a>

This is optional. Cantaloupe can be installed under an existing Tomcat or run as a standalone service. The latter is recommended by the Cantaloupe project, though the former is supported. The later makes separability of services easier if necessary. To install under the Fedora Tomcat:

`cp /usr/local/Cantaloupe-3.4.2/Cantaloupe-3.4.2.war $CATALINA_HOME/webapps/cantaloupe.war && chown -R tomcat7:tomcat7 $CATALINA_HOME/webapps/cantaloupe*`

And add the following line to `/etc/default/tomcat7`:

`JAVA_OPTS="${JAVA_OPTS} -Dcantaloupe.config=/usr/local/cantaloupe/cantaloupe.properties`

To install under the Blazegraph Tomcat:

`cp /usr/local/Cantaloupe-3.4.2/Cantaloupe-3.4.2.war /usr/share/tomcat7-blzg/webapps/cantaloupe.war && chown -R blazegraph:blazegraph /usr/share/tomcat7-blzg/webapps/cantaloupe*`

Also edit `/var/bigdata/.bash_profile` to add the appropriate JAVA_OPTS option.

To install Cantaloupe as a standalone service, do the following:
```
cd ~

useradd -d /srv/cantaloupe/home -s /bin/false cantaloupe

chown -R cantaloupe:cantaloupe /srv/cantaloupe /usr/local/Cantaloupe-3.4.2
```
Set up the `cantaloupe` service:
```
cat > /etc/systemd/system/cantaloupe.service <<END_CL
[Unit]
Description=Cantaloupe Image Server

[Service]
Type=simple
User=cantaloupe
ExecStart=/usr/bin/nohup /usr/bin/java -Dcantaloupe.config=/usr/local/cantaloupe/cantaloupe.properties -Xmx256m -jar /usr/local/cantaloupe/Cantaloupe-3.4.2.war
ExecStop=/usr/bin/killall -9 Cantaloupe-3.4.2.war
Restart=on-failure

[Install]
WantedBy=multi-user.target
END_CL

systemctl daemon-reload

systemctl enable cantaloupe.service

systemctl start cantaloupe.service

cat > /root/bin/cantaloupe-purge.sh <<END_CLP
#!/bin/bash
cd /usr/local/cantaloupe
sudo -u cantaloupe java -Dcantaloupe.config=/usr/local/cantaloupe/cantaloupe.properties -Dcantaloupe.cache.purge -jar Cantaloupe-3.4.1.war
END_CLP

chmod 750 /root/bin/cantaloupe-purge.sh
```
Root's crontab should contain something like this:
```
# Cantaloupe daily purge of cache
00 23 * * * /root/bin/cantaloupe-purge.sh >>/root/cantaloupe-purge.log 2>&1
```
Regardless of how you install Cantaloupe, do the following configuration:
```
cd /usr/local/cantaloupe

cp cantaloupe.properties.sample cantaloupe.properties

sed -i "s|temp_pathname = *|temp_pathname = /srv/tmp|" cantaloupe.properties

sed -i "s|http.host = 0.0.0.0|http.host = 127.0.0.1|" cantaloupe.properties

sed -i "s|FilesystemResolver.BasicLookupStrategy.path_prefix = /home/myself/images/|FilesystemResolver.BasicLookupStrategy.path_prefix = /tmp/|" cantaloupe.properties

sed -i "s|log.application.level = debug|log.application.level = warn|" cantaloupe.properties

sed -i "s|log.application.ConsoleAppender.enabled = true|log.application.ConsoleAppender.enabled = false|" cantaloupe.properties

sed -i "s|log.application.FileAppender.pathname = /path/to/logs/application.log|log.application.FileAppender.pathname = /srv/cantaloupe/log/application.log|" cantaloupe.properties

sed -i "s|log.application.RollingFileAppender.enabled = false|log.application.RollingFileAppender.enabled = true|" cantaloupe.properties

sed -i "s|log.application.RollingFileAppender.pathname = /path/to/logs/application.log|log.application.RollingFileAppender.pathname = /srv/cantaloupe/log/application.log|" cantaloupe.properties

sed -i "s|log.application.RollingFileAppender.TimeBasedRollingPolicy.filename_pattern = /path/to/logs/application-%d{yyyy-MM-dd}.log|log.application.RollingFileAppender.TimeBasedRollingPolicy.filename_pattern = /srv/cantaloupe/log/application-%d{yyyy-MM-dd}.log|" cantaloupe.properties

sed -i "s|log.error.FileAppender.enabled = false|log.error.FileAppender.enabled = true|" cantaloupe.properties

sed -i "s|log.error.FileAppender.pathname = /path/to/logs/error.log|log.error.FileAppender.pathname = /srv/cantaloupe/log/error.log|" cantaloupe.properties

sed -i "s|log.error.RollingFileAppender.pathname = /path/to/logs/error.log|log.error.RollingFileAppender.pathname = /srv/cantaloupe/log/error.log|" cantaloupe.properties

sed -i "s|log.error.RollingFileAppender.TimeBasedRollingPolicy.filename_pattern = /path/to/logs/error-%d{yyyy-MM-dd}.log|log.error.RollingFileAppender.TimeBasedRollingPolicy.filename_pattern = /srv/cantaloupe/log/error-%d{yyyy-MM-dd}.log|" cantaloupe.properties

sed -i "s|log.access.FileAppender.pathname = /path/to/logs/access.log|log.access.FileAppender.pathname = /srv/cantaloupe/log/access.log|" cantaloupe.properties

sed -i "s|log.access.RollingFileAppender.pathname = /path/to/logs/access.log|log.access.RollingFileAppender.pathname = /srv/cantaloupe/log/access.log|" cantaloupe.properties

sed -i "s|log.access.RollingFileAppender.TimeBasedRollingPolicy.filename_pattern = /path/to/logs/access-%d{yyyy-MM-dd}.log|log.access.RollingFileAppender.TimeBasedRollingPolicy.filename_pattern = /srv/cantaloupe/log/access-%d{yyyy-MM-dd}.log|" cantaloupe.properties

sed -i "s|processor.jp2 = KakaduProcessor|processor.jp2 = OpenJpegProcessor|" cantaloupe.properties

sed -i "s|StreamProcessor.retrieval_strategy = StreamStrategy|StreamProcessor.retrieval_strategy = CacheStrategy|" cantaloupe.properties

sed -i "s|cache.server.source.enabled = false|cache.server.source.enabled = true|" cantaloupe.properties

sed -i "s|cache.server.derivative =*|cache.server.derivative = FilesystemCache|" cantaloupe.properties

sed -i "s|cache.server.worker.enabled = false|cache.server.worker.enabled = true|" cantaloupe.properties

sed -i "s|resolver.static = FilesystemResolver|resolver.static = HttpResolver|" cantaloupe.properties

sed -i "s|HttpResolver.trust_all_certs = false|HttpResolver.trust_all_certs = true|" cantaloupe.properties

# - DigiBESS and Islandora Vagrant differ on these
#sed -i "s|endpoint.iiif.content_disposition = none|endpoint.iiif.content_disposition = inline|" cantaloupe.properties

#sed -i "s|processor.limit_to_8_bits = true|processor.limit_to_8_bits = false|" cantaloupe.properties

#sed -i "s|cache.server.derivative.enabled = false|cache.server.derivative.enabled = true|" cantaloupe.properties

#sed -i "s|cache.server.ttl_seconds = 2592000|cache.server.ttl_seconds = 259200|" cantaloupe.properties

#sed -i "s|FilesystemCache.pathname = /var/cache/cantaloupe|FilesystemCache.pathname = /srv/cantaloupe/cache|" cantaloupe.properties

#sed -i "s|HttpResolver.lookup_strategy = BasicLookupStrategy|HttpResolver.lookup_startegy = ScriptLookupStrategy|" cantaloupe.properties

#sed -i "s|HttpResolver.BasicLookupStrategy.url_prefix = http://localhost/images/|HttpResolver.BasicLookupStrategy.url_prefix =|" cantaloupe.properties

#sed -i "s|HttpResolver.auth.basic.username =|HttpResolver.auth.basic.username = anonymous|" cantaloupe.properties

#sed -i "s|HttpResolver.auth.basic.secret =|HttpResolver.auth.basic.secret = anonymous|" cantaloupe.properties
```

Islandora Vagrant uses a Cantaloupe provided script, called `delegates-3.4.rb` that permits "obfuscation" of URLs. We leave further configuration of this service as an exercise to the reader. See the DigiBESS site.


#### Setup Logging <a id="setup-logging"></a>
Please note logging still needs some TLC: log4j and logrotate clash with some files: 
``` 
cd ~ 

git clone https://github.com/discoverygarden/islandora_log_config.git

cd islandora_log_config

cp log4j.xml $CATALINA_HOME/webapps/fedoragsearch/WEB-INF/classes/log4j.xml 

cp -p $CATALINA_HOME/conf/logging.properties $CATALINA_HOME/conf/logging.properties.bak

cp logging.properties $CATALINA_HOME/conf/logging.properties

### Chose one of these, depending on where you installed Adore-Djatoka, with Fedora or with Blazegraph
# - with Fedora
#cp log4j.properties $CATALINA_HOME/webapps/adore-djatoka/WEB-INF/classes/log4j.properties
# - with Blazegraph
#cp log4j.properties /usr/share/tomcat7-blzg/webapps/adore-djatoka/WEB-INF/classes/log4j.properties
# - Also do the following if you installed Adore-Djatoka with Blazegraph
#sed -i "s|/usr/local/fedora/server/logs|/var/bigdata/logs|" /usr/share/tomcat7-blzg/webapps/adore-djatoka/WEB-INF/classes/log4j.properties

cp logback.xml $FEDORA_HOME/server/config/logback.xml

chown -R blazegraph:blazegraph /usr/share/tomcat7-blzg/

systemctl restart blazegraph

cd ~

rm -rf islandora_log_config
```

#### Drupal Filter <a id="drupal-filter"></a>

Setup Drupal filter:  

This follows instructions from https://github.com/discoverygarden/fcrepo3-security-jaas/blob/master/README.md (thanks @lutaylor!).

See also: https://github.com/discoverygarden/fcrepo3-security-jaas/blob/master/docs/multisite-optimization.md.
```
cd ~

# - gets us version 7.1.11
git clone https://github.com/Islandora/islandora_drupal_filter.git

cd islandora_drupal_filter

mvn -Dfedora.version=$FEDORA_VERSION install

cd ~

mv islandora_drupal_filter/target/fcrepo-drupalauthfilter-3.8.1.jar $CATALINA_HOME/webapps/fedora/WEB-INF/lib/

chown -R $FEDORA_USER:$FEDORA_USER $CATALINA_HOME

#Note: The following currently fails to compile, due to a missing dependency (possibly 'islandora_drupal_filter' v 7.1.10)
#git clone https://github.com/discoverygarden/fcrepo3-security-jaas.git

#cd fcrepo3-security-jaas/

#mvn package -Dfedora.version=$FEDORA_VERSION

cat > $FEDORA_HOME/server/config/jass.conf <<END_DF
fedora-auth
{
	org.fcrepo.server.security.jaas.auth.module.XmlUsersFileModule required
	debug=true;
	ca.upei.roblib.fedora.servletfilter.DrupalAuthModule required
	debug=true;
};

fedora-auth-xmlusersfile
{
	org.fcrepo.server.security.jaas.auth.module.XmlUsersFileModule required
	debug=true;
};

fedora-auth-ldap-bind
{
	org.fcrepo.server.security.jaas.auth.module.LdapModule required
	host.url="ldap://dev01.muradora.org"
	auth.type="simple"
	bind.mode="bind"
	bind.filter="uid={0},ou=people,dc=muradora,dc=org"
	debug=true;
};

fedora-auth-ldap-bind-search-bind
{
	org.fcrepo.server.security.jaas.auth.module.LdapModule required
	host.url="ldap://dev01.muradora.org"
	auth.type="simple"
	bind.mode="bind-search-bind"
	bind.user="uid=binduser,ou=people,dc=muradora,dc=org"
	bind.pass="murabind"
	search.base="ou=people,dc=muradora,dc=org"
	search.filter="(uid={0})"
	attrs.fetch="cn,sn,mail,displayName,carLicense"
	debug=true;
};

fedora-auth-ldap-bind-search-compare
{
	org.fcrepo.server.security.jaas.auth.module.LdapModule required
	host.url="ldap://dev01.muradora.org"
	auth.type="simple"
	bind.mode="bind-search-compare"
	bind.user="uid=binduser,ou=people,dc=muradora,dc=org"
	bind.pass="murabind"
	search.base="ou=people,dc=muradora,dc=org"
	search.filter="(uid={0})"
	attrs.fetch="cn,sn,mail,displayName,carLicense"
	debug=true;
};
END_DF

cd $FEDORA_HOME/server/config  

wget https://raw.github.com/Islandora/islandora_drupal_filter/master/filter-drupal.xml 

sed -i "s|DB_SERVER|$DB_SERVER|g" filter-drupal.xml

sed -i "s|DRUPAL_DB_NAME|$DRUPAL_DB_NAME|g" filter-drupal.xml

sed -i "s|DRUPAL_DB_USER|$DRUPAL_DB_USER|g" filter-drupal.xml 

sed -i "s|DRUPAL_DB_PASS|$DRUPAL_DB_PASS|g" filter-drupal.xml
```

Start Fedora fully configured:

`chown -R $FEDORA_USER:$FEDORA_USER $FEDORA_HOME`  

`chown -R $FEDORA_USER:$FEDORA_USER $CATALINA_HOME` 

`systemctl restart tomcat7`

### Install Drupal  <a id="install-drupal"></a>

#### CLUI Config <a id="clui-config"></a>

**Note:** Some libraries, modules, contrib are optional but are included to support additional theming. e.g. features, strongarm, node_export.
 
```
cd $OS_DEFAULT_DOCUMENTROOT

drush dl drupal  

mv drupal-7* drupal7

# or, alternatively (makes upgrades easier)
#ln -s drupal-7* drupal7

cd drupal7

mkdir sites/default/files  

mkdir sites/all/{modules,themes,libraries}

cp sites/default/default.settings.php sites/default/settings.php
```

#### Islandora Modules  <a id="islandora-modules"></a>

Git clone the following modules:  

`modslist.sh` helper script to handle the git repos to install modules:  
```
cd ~

cat > modslist.sh <<END_IM
#!/bin/bash
cd /var/www/drupal7/sites/all/modules

git clone https://github.com/Islandora/islandora.git

git clone https://github.com/Islandora/islandora_scholar.git

git clone https://github.com/discoverygarden/google_analytics_reports.git

git clone https://github.com/discoverygarden/islandora_ga_reports.git

git clone https://github.com/Islandora/islandora_solr_search.git

git clone https://github.com/Islandora/islandora_solr_views.git

git clone https://github.com/Islandora/islandora_solution_pack_collection.git

git clone https://github.com/Islandora/objective_forms.git

git clone https://github.com/Islandora/islandora_xml_forms.git

git clone https://github.com/Islandora/islandora_xmlsitemap.git

git clone https://github.com/Islandora/php_lib.git

git clone https://github.com/Islandora/islandora_importer.git

git clone https://github.com/Islandora/islandora_bookmark.git

git clone https://github.com/Islandora/islandora_badges.git

git clone https://github.com/Islandora/islandora_form_fieldpanel.git

git clone https://github.com/Islandora/islandora_newspaper_batch.git

git clone https://github.com/Islandora/islandora_pdfjs.git

git clone https://github.com/Islandora/islandora_populator.git

git clone https://github.com/Islandora/islandora_oai.git

git clone https://github.com/Islandora/islandora_pathauto.git

git clone https://github.com/Islandora/islandora_solution_pack_audio.git

git clone https://github.com/Islandora/islandora_solution_pack_book.git

git clone https://github.com/Islandora/islandora_solution_pack_image.git

git clone https://github.com/Islandora/islandora_solution_pack_large_image.git

git clone https://github.com/Islandora/islandora_solution_pack_pdf.git

git clone https://github.com/Islandora/islandora_solution_pack_video.git

git clone https://github.com/Islandora/islandora_solution_pack_web_archive.git

git clone https://github.com/Islandora/islandora_paged_content.git

git clone https://github.com/Islandora/islandora_internet_archive_bookreader.git

git clone https://github.com/Islandora/islandora_ocr.git

git clone https://github.com/Islandora/islandora_openseadragon.git

git clone https://github.com/Islandora/islandora_videojs.git

git clone https://github.com/Islandora/islandora_usage_stats.git

git clone https://github.com/Islandora/islandora_fits.git

git clone https://github.com/Islandora/islandora_simple_workflow.git

git clone https://github.com/Islandora/islandora_book_batch.git

git clone https://github.com/Islandora/islandora_batch.git

git clone https://github.com/Islandora/islandora_ip_embargo.git

git clone https://github.com/Islandora/islandora_solution_pack_compound.git

git clone https://github.com/Islandora/islandora_solution_pack_newspaper.git

git clone https://github.com/Islandora/islandora_xacml_editor.git

git clone https://github.com/Islandora/islandora_marcxml.git

git clone https://github.com/discoverygarden/islandora_featured_collection.git

git clone https://github.com/Islandora/islandora_solr_metadata.git

git clone https://github.com/Islandora/islandora_solr_facet_pages.git

git clone https://github.com/discoverygarden/solrmetadataconfigs.git

git clone https://github.com/discoverygarden/islandora_solution_pack_document.git

git clone https://github.com/discoverygarden/islandora_gsearcher.git

git clone https://github.com/discoverygarden/islandora_jodconverter.git

git clone https://github.com/discoverygarden/islandora_plupload.git

git clone https://github.com/discoverygarden/islandora_solution_pack_entities.git

git clone https://github.com/Islandora-Labs/islandora_binary_object.git

git clone https://github.com/Islandora/islandora_checksum.git

git clone https://github.com/Islandora/islandora_checksum_checker.git

git clone https://github.com/Islandora/islandora_premis.git

git clone https://github.com/Islandora/islandora_bagit.git
END_IM

chmod +x modslist.sh

./modslist.sh

rm modslist.sh
```
Note: the `islandora_ip_embargo` module appears to depend on a missing module `islandora_access_override` which is not available. This will generate an error when enabling the modules in Drupal. You can ignore it.

Dependency if `bagit` is to be used: 
 
`/usr/bin/pear install Archive_Tar`

#### Libraries <a id="libraries"></a>
```
cd /var/www/drupal7/sites/all/libraries/

git clone -b $TUQUE_BRANCH git://github.com/Islandora/tuque.git

git clone  https://github.com/Islandora/internet_archive_bookreader.git bookreader

wget https://github.com/openseadragon/openseadragon/releases/download/v2.3.1/openseadragon-bin-2.3.1.zip  && unzip openseadragon-bin-2.3.1.zip && rm -rf openseadragon-bin-2.3.1.zip && mv openseadragon-bin-2.3.1 openseadragon

wget https://github.com/moxiecode/plupload/archive/v1.5.8.zip -O v1.5.8.zip && unzip -o v1.5.8.zip && rm -rf v1.5.8.zip && mv plupload-1.5.8 plupload

wget http://sourceforge.net/projects/jodconverter/files/JODConverter/2.2.2/jodconverter-2.2.2.zip/download -O jodconverter-2.2.2.zip && unzip -o jodconverter-2.2.2.zip && rm -rf jodconverter-2.2.2.zip

wget https://github.com/jackmoore/colorbox/archive/1.x.zip -O colorbox-1.x.zip && unzip colorbox-1.x.zip && rm -rf colorbox-1.x.zip && mv colorbox-1.x colorbox

mkdir pdfjs && cd pdfjs && wget https://github.com/mozilla/pdf.js/releases/download/v1.9.426/pdfjs-1.9.426-dist.zip && unzip pdfjs-1.9.426-dist.zip && rm -rf pdfjs-1.9.426-dist.zip && cd ..

mkdir jquery.cycle && cd jquery.cycle && wget http://malsup.github.com/jquery.cycle.all.js && cd .. 

drush dl imagemagick libraries views ctools oauth chart google_analytics views_slideshow views_responsive_grid strongarm features designkit conditional_styles socialmedia widgets features_extra uuid node_export block_class ldap entity colorbox rules xmlsitemap css_injector token date datepicker devel pathauto jquery_update variable xmlsitemap views_data_export
```

Optionally, if you intend to do some Drupal coding, `drush dl coder`. You will be prompted to choose a version. Try item 1.

#### Drupal site install <a id="drupal-site-install"></a>

**Please note that you should consider making the drupal directory permissions more secure. These permissions will allow you to install modules through the drupal web interface however if this functionality is not required recommend locking down permissions using something such as https://github.com/discoverygarden/secure_drupal_file after the install.**
```
chown -R -H $APACHE_USER:$APACHE_USER /var/www/drupal7

drush -y site-install standard --account-name=$DRUPAL_ADMIN_USER --account-pass=$DRUPAL_ADMIN_PASS --db-url=mysql://$DRUPAL_DB_USER:$DRUPAL_DB_PASS@localhost/$DRUPAL_DB_NAME
```
Secure `settings.php`:
 
`chmod 440 /var/www/drupal7/sites/default/settings.php`

Drush Enables and Configuration:
```
drush -y en block color comment contextual dashboard dblog field field_sql_storage field_ui file filter help image list menu node number options overlay path rdf shortcut system taxonomy text toolbar user bartik seven imagemagick libraries views update ctools oauth_common oauth_common_providerui system_charts chart_views chart googleanalytics views_responsive_grid strongarm features designkit conditional_styles fe_block uuid node_export node_export_features widgets socialmedia block_class colorbox rules entity_token css_injector token date datepicker devel pathauto jquery_update variable xmlsitemap views_data_export

drush -y colorbox-plugin

drush -y dis overlay

drush vset islandora_base_url "$ISLANDORA_BASE"

drush vset islandora_solr_url "$SOLR_BASE"

drush -y --user=1 en islandora islandora_audio islandora_basic_collection islandora_basic_image islandora_fits islandora_importer islandora_openseadragon islandora_simple_workflow islandora_video islandora_videojs islandora_pdf  islandora_paged_content islandora_ocr islandora_internet_archive_bookreader islandora_large_image islandora_book islandora_batch islandora_book_batch xml_form_api xml_form_elements xml_schema_api objective_forms php_lib islandora_solr islandora_solr_config islandora_solr_views islandora_ga_reports islandora_scholar islandora_oai google_analytics_reports islandora_importer xml_form_builder xml_forms islandora_bibliography islandora_scholar_embargo islandora_google_scholar islandora_marcxml islandora_xacml_editor islandora_xacml_api zip_importer pmid_importer ris_importer islandora_bookmark doi_importer endnotexml_importer citation_exporter bartik seven imagemagick libraries views views_ui ctools csl citeproc oauth_common oauth_common_providerui system_charts chart_views chart googleanalytics islandora_compound_object islandora_ip_embargo islandora_newspaper views_slideshow views_slideshow_cycle islandora_featured_collection islandora_solr_metadata islandora_document islandora_jodconverter islandora_entities islandora_entities_csv_import islandora_binary_object islandora_badges islandora_newspaper_batch islandora_pathauto islandora_pdfjs islandora_solr_facet_pages islandora_web_archive islandora_form_fieldpanel islandora_usage_stats islandora_xmlsitemap

drush -y islandora_videojs videojs-plugin

drush php-eval "variable_set('islandora_large_image_viewers', array('name' => array('none' => 'none', 'islandora_openseadragon' => 'islandora_openseadragon'),'default' => 'islandora_openseadragon'));"

drush php-eval "variable_set('islandora_video_viewers', array('name' => array('none' => 'none', 'islandora_videojs' => 'islandora_videojs'),'default' => 'islandora_videojs'));"

drush php-eval "variable_set('islandora_audio_viewers', array('name' => array('none' => 'none', 'islandora_videojs' => 'islandora_videojs'),'default' => 'islandora_videojs'));"

drush php-eval "variable_set('islandora_book_viewers', array('name' => array('none' => 'none', 'islandora_internet_archive_bookreader' => 'islandora_internet_archive_bookreader'), 'default' => 'islandora_internet_archive_bookreader'));"

drush php-eval "variable_set('islandora_book_page_viewers', array('name' => array('none' => 'none', 'islandora_openseadragon' => 'islandora_openseadragon'), 'default' => 'islandora_openseadragon'));"

drush php-eval "variable_set('islandora_newspaper_page_viewers', array('name' => array('none' => 'none', 'islandora_openseadragon' => 'islandora_openseadragon'),'default' => 'islandora_openseadragon'))"

drush php-eval "variable_set('islandora_newspaper_issue_viewers', array('name' => array('none' => 'none', 'islandora_internet_archive_bookreader' => 'islandora_internet_archive_bookreader'),'default' => 'islandora_internet_archive_bookreader'))"

drush vset islandora_pdf_create_fulltext "1"

drush vset islandora_pdf_path_to_pdftotext `which pdftotext`  

drush vset islandora_metadata_display "islandora_solr_metadata"

drush vset islandora_fits_executable_path "/usr/local/fits/fits.sh" 

drush vset islandora_book_tesseract `which tesseract`  

drush vset islandora_ocr_tesseract `which tesseract`  

drush vset islandora_batch_java `which java`  

drush php-eval "variable_set('islandora_ocr_tesseract_enabled_languages', array('deu-frak' => deu-frak, 'eng' => eng, 'fra' => fra, 'ita' => ita, 'jpn' => jpn, 'por' => por, 'spa' => spa, 'dan-frak' => 0, 'deu' => 0, 'hin' => 0, 'ita_old' => 0, 'rus' => 0, 'slk-frak' => 0, 'spa_old' => 0));"

drush vset islandora_lame_url `which lame`

drush vset islandora_video_ffmpeg_path `which ffmpeg`  

drush vset islandora_video_ffmpeg2theora_path `which ffmpeg2theora`  

drush vset islandora_paged_content_gs `which gs`  

drush vset imagemagick_convert `which convert`

drush vset islandora_document_create_fulltext "1"  

drush vset islandora_document_path_to_pdftotext `which pdftotext`

drush vset site_name "Stock Islandora and Fedora"

drush vset image_toolkit "imagemagick"

drush vset error_level $ERROR_LEVEL

drush php-eval "variable_set('oai2_date_field', 'fgs_lastModifiedDate_dt')"
```

**Note:** This should be a publicly resolvable URL or viewers will not work for people who cannot resolve the name. You also should ensure that the /etc/hosts file is pointing the name at localhost.
  
```
drush vset islandora_paged_content_djatoka_url $DNS_HOSTNAME

drush vset user_register 0 

drush -y updb

drush -y cc all

systemctl restart $APACHE_SERVICE

drush cc all
```
Don't forget to configure the Temporary directory, as discussed in the LibreOffice section.

### Follow-up Notes <a id="notes"></a>

Islandora GSearcher is installed but not enabled. See `https://github.com/discoverygarden/islandora_gsearcher` for more information.

More tesseract languages can be found here: [https://code.google.com/p/tesseract-ocr/downloads/list](https://code.google.com/p/tesseract-ocr/downloads/list)

Recommend locking down Drupal permissons on Production e.g. run something like https://github.com/discoverygarden/secure_drupal_file

Keep server firewalled in production! Don't expose any ports to the Internet asides from 80/443. Port 8080 should be kept locked down to localhost only. Use `fail2ban` (installed above) to control `ssh` access at the least. Set up email on the server using `postfix` or your favourite email server and configure it to send system and Drupal admin emails to you.

Visit https://github.com/discoverygarden/basic-solr-config/wiki/performance-tuning-for-multithreaded-solr-ingest if interested in multi fgsupdaters. Be warned this can drastically increase HEAP pressure if not careful. 
